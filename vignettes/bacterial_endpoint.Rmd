---
title: "bacterial_endpoint"
author: "Hisham M Shaikh"
date: '2023-07-07'
output: html_document
---

This Rmarkdown will document the use of bacterial growth rate based end point for viral production studies.
We will also compare how the three different methods compare to this.

# Setting up the environment

```{r}
library(readr)
library(tidyverse)
library(ggsci)

```

# Importing dataset

```{r}
bep_df <- read_csv("./V5000/vp_calc_bp.csv") #This dataframe only has the endpoint time ranges
summary
#We'll add a column to flag this data as the endpoint data
bep_df$Time_Range_Type <- "BEP"
#We will add T0-T24 time range to this dataframe

all_df <- read_csv("./V5000/vp_calc_all.csv")


bep_df<- rbind(bep_df, all_df %>% filter(Time_Range == 'T0_T24')
               %>% mutate(Time_Range_Type = 'T0_T24'))
unique(bep_df$Time_Range_Type)
unique(bep_df$VP_Type)

```
We have our dataframe now. It's time to visualise this data.

# Visualisation

Variables:\
1. VP_Type - 3 - VP, VPC, Diff\
2. Time_range_Type | 2 | BEP, T0_T24\
3. VP_Type - 4 (?) VIPCAL-SE only ? or VIPCAL, VIPCAL-SE, LM-AP, and LM-supervised\
\
\
Let's start with only VIPCAL-SE and total viruses\


```{r}
vpcl_se_df <- bep_df %>% filter(
                                Population == 'c_Viruses',
                                VP_Type %in% c("LM_AP",
                                             "VPCL_AR_Diff_No_SE",
                                             "VPCL_AR_Diff_LMER_SE")) %>%
  mutate(VP = replace_na(VP, 0))  %>%
  arrange(Location, Depth, Expt_No, Population, 
          Sample_Type, VP_Type, Time_Range_Type)
vpcl_se_df$Sample_Type <- factor(vpcl_se_df$Sample_Type,
                                 levels = c('VP', 'VPC', 'Diff'))

vpcl_se_df$VP_Type <- factor(vpcl_se_df$VP_Type,
                                 levels = c('LM_AP', 'VPCL_AR_Diff_No_SE', 'VPCL_AR_Diff_LMER_SE'),
                             label = c("LM", "VIPCAL", "VIPCAL-SE"))


bep_time_ranges<- vpcl_se_df %>% 
  filter(Time_Range_Type == 'BEP') %>%
  select(Expt_No, Time_Range) %>%
  unique()




gs_df1 <- vpcl_se_df %>%
  select(-c(VP_SE, VP_R_Squared, Location, Depth, Population)) %>%
  ungroup()%>%
  pivot_wider(id_cols = !Time_Range,
              names_from = Time_Range_Type,
              values_from = VP)%>%
  rowwise() %>%
  mutate(start = min(BEP, T0_T24),
         end = max(BEP, T0_T24),
         sign = sign(BEP-T0_T24)) 

  gs_df1<- merge(gs_df1, bep_time_ranges)

  

gs_df2<- vpcl_se_df %>%
  select(-c(VP_SE, VP_R_Squared)) %>%
  # mutate(Time_Range_Type2 = Time_Range_Type)%>%
  group_by(Location, 
           Depth, VP_Type,
           Population, Sample_Type) 


ggplot(data = gs_df2 ,
       aes(x = as.factor(Expt_No),
           y = VP))+
  geom_segment(data = gs_df1,
               aes(x = as.factor(Expt_No),
                   xend = as.factor(Expt_No),
                   y = start,
                   yend = end,
                   color = as.factor(sign)),
               linewidth = 1)+
  geom_point(aes(color = Time_Range,
                 shape = Time_Range_Type),
             size = 3) +
  scale_color_npg()+
  theme_bw()+
  theme(#legend.position = 'none'
        )+
  facet_grid(Sample_Type ~ VP_Type,
             scales = 'free')+
  theme(strip.background = element_rect(fill = NA),
        legend.position = 'bottom',
        axis.text = element_text(size = 15),
        axis.title = element_text(size = 15,
                                  face = 'bold'),
        strip.text = element_text(size = 15,
                                  face = 'bold'))+
  labs(x = 'Experiment',
       y = 'Viral Production')



```
```{r}

ggplot(data = gs_df1,
       aes(x = BEP,
           y = T0_T24,
           color = as.factor(Expt_No),
           shape = Time_Range))+
  geom_point(size = 3,
             alpha = 0.5)+
  geom_abline(slope =1,
              linewidth  =1)+
  theme_bw()+
  facet_grid(Sample_Type ~ VP_Type,
             scales = 'fixed')+
  theme(strip.background = element_rect(color = NA,
                                        fill = NA),
        legend.position = 'bottom')+
  labs(x = 'Bacterial Endpoint',
       y = 'T0-T24')+
  guides(color = guide_legend('Experiment'),
         shape = guide_legend('Endpoint Time Range'))
```